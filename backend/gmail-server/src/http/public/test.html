<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail MCP Server Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .card h2 {
      color: #333;
      margin-bottom: 16px;
      font-size: 18px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dc3545;
    }
    .status-dot.connected {
      background: #28a745;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: 500;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .result {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .auth-link {
      display: inline-block;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
    }
    .auth-link:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gmail MCP Server Test</h1>

    <div class="card">
      <h2>Connection Status</h2>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Checking...</span>
      </div>
      <a href="/auth/login" class="auth-link" id="authLink" style="display: none;">Authenticate with Google</a>
    </div>

    <div class="card">
      <h2>Test Tools</h2>
      <div class="form-group">
        <label>Select Tool</label>
        <select id="toolSelect">
          <option value="get_profile">Get Profile</option>
          <option value="list_messages">List Messages</option>
          <option value="list_labels">List Labels</option>
          <option value="search_messages">Search Messages</option>
          <option value="send_message">Send Message</option>
        </select>
      </div>

      <div id="toolParams"></div>

      <button onclick="executeTool()" id="executeBtn">Execute</button>
    </div>

    <div class="card">
      <h2>Result</h2>
      <div class="result" id="result">Click "Execute" to see results...</div>
    </div>
  </div>

  <script>
    const toolParams = {
      get_profile: [],
      list_messages: [
        { name: 'maxResults', type: 'number', label: 'Max Results', default: 10 },
        { name: 'query', type: 'text', label: 'Search Query (optional)', default: '' }
      ],
      list_labels: [],
      search_messages: [
        { name: 'query', type: 'text', label: 'Search Query', required: true },
        { name: 'maxResults', type: 'number', label: 'Max Results', default: 10 }
      ],
      send_message: [
        { name: 'to', type: 'email', label: 'To', required: true },
        { name: 'subject', type: 'text', label: 'Subject', required: true },
        { name: 'body', type: 'textarea', label: 'Body', required: true }
      ]
    };

    // Check health on load
    async function checkHealth() {
      try {
        const res = await fetch('/health');
        const data = await res.json();

        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        const authLink = document.getElementById('authLink');

        if (data.authenticated) {
          dot.classList.add('connected');
          text.textContent = 'Connected & Authenticated';
          authLink.style.display = 'none';
        } else {
          text.textContent = 'Not authenticated';
          authLink.style.display = 'inline-block';
        }
      } catch (err) {
        document.getElementById('statusText').textContent = 'Server not reachable';
      }
    }

    // Update params form when tool changes
    document.getElementById('toolSelect').addEventListener('change', updateParamsForm);

    function updateParamsForm() {
      const tool = document.getElementById('toolSelect').value;
      const params = toolParams[tool] || [];
      const container = document.getElementById('toolParams');

      container.innerHTML = params.map(p => `
        <div class="form-group">
          <label>${p.label}${p.required ? ' *' : ''}</label>
          ${p.type === 'textarea'
            ? `<textarea id="param_${p.name}" placeholder="${p.default || ''}">${p.default || ''}</textarea>`
            : `<input type="${p.type}" id="param_${p.name}" value="${p.default || ''}" placeholder="${p.label}">`
          }
        </div>
      `).join('');
    }

    async function executeTool() {
      const tool = document.getElementById('toolSelect').value;
      const params = toolParams[tool] || [];
      const args = {};

      params.forEach(p => {
        const el = document.getElementById(`param_${p.name}`);
        if (el && el.value) {
          args[p.name] = p.type === 'number' ? parseInt(el.value) : el.value;
        }
      });

      const btn = document.getElementById('executeBtn');
      btn.disabled = true;
      btn.textContent = 'Executing...';

      try {
        const res = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: Date.now(),
            method: 'tools/call',
            params: { name: tool, arguments: args }
          })
        });

        const data = await res.json();
        document.getElementById('result').textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('result').textContent = `Error: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Execute';
      }
    }

    // Initialize
    checkHealth();
    updateParamsForm();
  </script>
</body>
</html>
